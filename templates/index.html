<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Ops Dashboard</title>
  <style>
    :root{
      --bg:#070b14; --panel:#111827cc; --line:#26324d; --txt:#eaf0ff; --muted:#93a4c9;
      --ok:#22c55e; --warn:#f59e0b; --run:#38bdf8; --bad:#ef4444; --off:#94a3b8;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--txt); font-family:Inter,Segoe UI,Arial,sans-serif;
      background: radial-gradient(1200px 500px at 10% -10%, #1d2e5c 0%, transparent 60%),
                  radial-gradient(900px 400px at 90% -20%, #153d4a 0%, transparent 55%),
                  var(--bg);
    }
    .wrap{max-width:1280px;margin:24px auto;padding:0 16px}
    .top{display:flex;align-items:end;justify-content:space-between;gap:12px;margin-bottom:14px}
    h1{margin:0;font-size:28px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--panel);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 10px 30px #00000033}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .v{font-size:28px;font-weight:700}
    .kpi .l{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    h2{margin:0 0 10px;font-size:15px;color:#c6d3f2}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid #2a3a5b;padding:8px;text-align:left}
    th{color:#b9c8ee;font-weight:600}
    .badge{display:inline-block;padding:3px 9px;border-radius:999px;font-size:12px;font-weight:600}
    .pending{background:#3b2c0a;color:#ffd27a}.running{background:#0c3147;color:#8ad4ff}
    .done{background:#133a22;color:#8ee6b0}.blocked{background:#4b1f1f;color:#ffb4b4}
    .cancelled{background:#374151;color:#d1d5db}
    .right{display:flex;gap:8px;align-items:center}
    .pill{border:1px solid var(--line);padding:5px 10px;border-radius:999px;font-size:12px;color:#c7d4f5}
    .dot{width:8px;height:8px;border-radius:50%;display:inline-block;background:var(--ok);margin-right:6px}
    .foot{margin-top:10px;font-size:12px;color:var(--muted)}
    @media (max-width:960px){.col-3,.col-4,.col-6,.col-8{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>游늵 Agent Ops Dashboard</h1>
        <div class="muted">Control centralizado de tareas, cron y consumo de tokens</div>
      </div>
      <div class="right">
        <div class="pill"><span class="dot"></span>online</div>
        <div class="pill">auto-refresh: 10s</div>
        <form method="post" action="/signals/refresh" style="margin:0">
          <button type="submit" class="pill" style="background:#1d3b72;border-color:#35518a;color:#fff;cursor:pointer">Actualizar se침ales</button>
        </form>
      </div>
    </div>

    {% set total_tasks = 0 %}
    {% for r in task_counts %}{% set total_tasks = total_tasks + r.c %}{% endfor %}
    {% set total_models = token_by_model|length %}
    {% set total_tokens = 0 %}
    {% for r in token_by_model %}{% set total_tokens = total_tokens + (r.total or 0) %}{% endfor %}

    <div class="grid">
      <div class="card col-3 kpi"><div class="l">Total tareas</div><div class="v">{{ total_tasks }}</div></div>
      <div class="card col-3 kpi"><div class="l">Modelos activos</div><div class="v">{{ total_models }}</div></div>
      <div class="card col-3 kpi"><div class="l">Tokens acumulados</div><div class="v">{{ total_tokens }}</div></div>
      <div class="card col-3 kpi"><div class="l">Cron registradas</div><div class="v">{{ cron_rows|length }}</div></div>

      <div class="card col-3 kpi"><div class="l">Equity (USD)</div><div class="v">{{ '%.2f'|format(portfolio_equity_usd) }}</div></div>
      <div class="card col-3 kpi"><div class="l">Cash (USD)</div><div class="v">{{ '%.2f'|format(portfolio_cash_usd) }}</div></div>
      <div class="card col-3 kpi"><div class="l">Market Value</div><div class="v">{{ '%.2f'|format(portfolio_market_value_usd) }}</div></div>
      <div class="card col-3 kpi"><div class="l">Posiciones</div><div class="v">{{ portfolio_positions|length }}</div></div>

      <div class="card col-4">
        <h2>Tareas por estado</h2>
        <table>
          <tr><th>Estado</th><th>Cantidad</th></tr>
          {% for r in task_counts %}
            <tr><td><span class="badge {{ r.status }}">{{ r.status }}</span></td><td>{{ r.c }}</td></tr>
          {% endfor %}
          {% if task_counts|length == 0 %}<tr><td colspan="2">Sin datos</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-8">
        <h2>Tokens por modelo</h2>
        <table>
          <tr><th>Modelo</th><th>In</th><th>Out</th><th>Total</th></tr>
          {% for r in token_by_model %}
            <tr><td>{{ r.model }}</td><td>{{ r.tin or 0 }}</td><td>{{ r.tout or 0 }}</td><td>{{ r.total or 0 }}</td></tr>
          {% endfor %}
          {% if token_by_model|length == 0 %}<tr><td colspan="4">Sin datos</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Historial de commits (칰ltimos cambios)</h2>
        <table>
          <tr><th>Commit</th><th>Fecha</th><th>Mensaje</th></tr>
          {% for c in commits %}
            <tr><td><code>{{ c.hash }}</code></td><td>{{ c.date }}</td><td>{{ c.msg }}</td></tr>
          {% endfor %}
          {% if commits|length == 0 %}<tr><td colspan="3">Sin datos de git</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Se침ales gratis (snapshot)</h2>
        <div class="muted" style="margin-bottom:8px">Generado: {{ signals.generated_at or 'N/D' }}</div>
        <div class="grid" style="grid-template-columns: repeat(12,1fr); gap:10px;">
          <div class="col-4" style="grid-column: span 4;">
            <h2>Macro (FRED)</h2>
            <table>
              <tr><th>Serie</th><th>칔ltimo</th><th>Fecha</th></tr>
              {% for m in signals.macro[:6] %}
                <tr><td>{{ m.series }}</td><td>{{ m.latest_value or '-' }}</td><td>{{ m.latest_date or '-' }}</td></tr>
              {% endfor %}
            </table>
          </div>
          <div class="col-4" style="grid-column: span 4;">
            <h2>Market (Yahoo)</h2>
            <table>
              <tr><th>Ticker</th><th>Precio</th><th>Exch</th></tr>
              {% for s in signals.market[:8] %}
                <tr><td>{{ s.ticker }}</td><td>{{ s.regularMarketPrice or '-' }}</td><td>{{ s.exchange or '-' }}</td></tr>
              {% endfor %}
            </table>
          </div>
          <div class="col-4" style="grid-column: span 4;">
            <h2>News (RSS)</h2>
            <table>
              <tr><th>Titular</th></tr>
              {% for feed in signals.news[:4] %}
                {% for item in feed['items'][:2] %}
                  <tr><td><a href="{{ item.link }}" target="_blank" style="color:#9ec5ff">{{ item.title_es or item.title }}</a></td></tr>
                {% endfor %}
              {% endfor %}
            </table>
          </div>
        </div>
      </div>

      <div class="card col-12">
        <h2>Crear tarea manual (con convicci칩n 1-5)</h2>
        <form method="post" action="/tasks/create" style="display:grid;grid-template-columns:2fr 1fr 1fr 120px;gap:8px;align-items:end">
          <div>
            <label class="muted">T칤tulo</label>
            <input name="title" required style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff" placeholder="Ej: Vigilar ruptura de NVDA con volumen" />
          </div>
          <div>
            <label class="muted">Agente</label>
            <input name="assigned_to" value="alpha-scout" style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff" />
          </div>
          <div>
            <label class="muted">Convicci칩n</label>
            <input name="conviction" type="number" min="1" max="5" value="3" style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff" />
          </div>
          <button type="submit" style="padding:10px;border-radius:10px;border:1px solid #35518a;background:#1d3b72;color:white;cursor:pointer">A침adir</button>
        </form>
      </div>

      <div class="card col-12">
        <h2>칔ltimas tareas</h2>
        <table>
          <tr><th>ID</th><th>Estado</th><th>Asign칩</th><th>Agente</th><th>T칤tulo</th><th>Convicci칩n</th><th>Actualizado</th><th>Acciones</th></tr>
          {% for r in recent_tasks %}
            {% set conv = '-' %}
            {% if r.details and '[conviction:' in r.details %}
              {% set conv = r.details.split('[conviction:')[1].split(']')[0] %}
            {% endif %}
            <tr>
              <td>{{ r.task_id }}</td>
              <td><span class="badge {{ r.status }}">{{ r.status }}</span></td>
              <td>{{ r.assigned_by }}</td>
              <td>{{ r.assigned_to }}</td>
              <td>{{ r.title }}</td>
              <td>{{ conv }}</td>
              <td>{{ r.updated_at }}</td>
              <td>
                <form method="post" action="/tasks/status" style="display:flex;gap:6px;flex-wrap:wrap">
                  <input type="hidden" name="task_id" value="{{ r.task_id }}" />
                  <button name="status" value="running" style="padding:4px 8px;border-radius:8px;border:1px solid #2a3a5b;background:#0c3147;color:#8ad4ff;cursor:pointer">Running</button>
                  <button name="status" value="done" style="padding:4px 8px;border-radius:8px;border:1px solid #2a3a5b;background:#133a22;color:#8ee6b0;cursor:pointer">Done</button>
                  <button name="status" value="blocked" style="padding:4px 8px;border-radius:8px;border:1px solid #2a3a5b;background:#4b1f1f;color:#ffb4b4;cursor:pointer">Blocked</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          {% if recent_tasks|length == 0 %}<tr><td colspan="8">Sin datos</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Cron registradas</h2>
        <table>
          <tr><th>Nombre</th><th>Cron</th><th>Activa</th><th>Owner</th><th>Task Ref</th><th>Actualizado</th></tr>
          {% for r in cron_rows %}
            <tr>
              <td>{{ r.name }}</td>
              <td>{{ r.cron_expr }}</td>
              <td>{{ 's칤' if r.active == 1 else 'no' }}</td>
              <td>{{ r.owner_user_id }}</td>
              <td>{{ r.task_ref }}</td>
              <td>{{ r.updated_at }}</td>
            </tr>
          {% endfor %}
          {% if cron_rows|length == 0 %}<tr><td colspan="6">Sin datos</td></tr>{% endif %}
        </table>
      </div>
    </div>

    <div class="foot">칔ltima actualizaci칩n: <span id="ts"></span></div>
  </div>
  <script>
    document.getElementById('ts').textContent = new Date().toLocaleString();
    setTimeout(() => location.reload(), 10000);
  </script>
</body>
</html>
