<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Ops Dashboard</title>
  <style>
    :root{
      --bg:#070b14; --panel:#111827cc; --line:#26324d; --txt:#eaf0ff; --muted:#93a4c9;
      --ok:#22c55e; --warn:#f59e0b; --run:#38bdf8; --bad:#ef4444; --off:#94a3b8;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--txt); font-family:Inter,Segoe UI,Arial,sans-serif;
      background: radial-gradient(1200px 500px at 10% -10%, #1d2e5c 0%, transparent 60%),
                  radial-gradient(900px 400px at 90% -20%, #153d4a 0%, transparent 55%),
                  var(--bg);
    }
    .wrap{max-width:1280px;margin:24px auto;padding:0 16px}
    .top{display:flex;align-items:end;justify-content:space-between;gap:12px;margin-bottom:14px}
    h1{margin:0;font-size:28px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--panel);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 10px 30px #00000033}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .v{font-size:28px;font-weight:700}
    .kpi .l{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    h2{margin:0 0 10px;font-size:15px;color:#c6d3f2}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid #2a3a5b;padding:8px;text-align:left}
    th{color:#b9c8ee;font-weight:600}
    .badge{display:inline-block;padding:3px 9px;border-radius:999px;font-size:12px;font-weight:600}
    .pending{background:#3b2c0a;color:#ffd27a}.running{background:#0c3147;color:#8ad4ff}
    .done{background:#133a22;color:#8ee6b0}.blocked{background:#4b1f1f;color:#ffb4b4}
    .cancelled{background:#374151;color:#d1d5db}
    .right{display:flex;gap:8px;align-items:center}
    .pill{border:1px solid var(--line);padding:5px 10px;border-radius:999px;font-size:12px;color:#c7d4f5}
    .dot{width:8px;height:8px;border-radius:50%;display:inline-block;background:var(--ok);margin-right:6px}
    .foot{margin-top:10px;font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
    .tab-btn{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#0d1423;color:#c7d4f5;cursor:pointer}
    .tab-btn.active{background:#1d3b72;border-color:#35518a;color:#fff}
    .tab-section{display:none}
    .tab-section.active{display:grid}
    @media (max-width:960px){.col-3,.col-4,.col-6,.col-8{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>üìä Dashboard Cerebro de Agentes</h1>
        <div class="muted">Control centralizado de tareas, cron, se√±ales y cartera</div>
      </div>
      <div class="right">
        <div class="pill"><span class="dot"></span>en l√≠nea</div>
        <div class="pill">auto-actualizaci√≥n: 30s</div>
        <div class="pill" style="{% if signals_stale %}border-color:#7a2e2e;color:#ffb4b4;background:#311;{% endif %}">se√±ales: {% if signals.freshness_min is not none %}hace {{ signals.freshness_min }} min{% else %}N/D{% endif %}{% if signals_stale %} ‚ö† stale{% endif %}</div>
        <form method="post" action="/signals/refresh" style="margin:0">
          <button type="submit" class="pill" style="background:#1d3b72;border-color:#35518a;color:#fff;cursor:pointer">Actualizar se√±ales</button>
        </form>
      </div>
    </div>

    {% set total_tasks = 0 %}
    {% for r in task_counts %}{% set total_tasks = total_tasks + r.c %}{% endfor %}
    {% set total_models = token_by_model|length %}
    {% set total_tokens = 0 %}
    {% for r in token_by_model %}{% set total_tokens = total_tokens + (r.total or 0) %}{% endfor %}

    <div class="tabs">
      <button class="tab-btn active" data-tab-btn="inicio">Inicio</button>
      <button class="tab-btn" data-tab-btn="oportunidades">Oportunidades</button>
      <button class="tab-btn" data-tab-btn="cartera">Cartera</button>
      <button class="tab-btn" data-tab-btn="agentes">Agentes</button>
      <button class="tab-btn" data-tab-btn="fuentes">Fuentes</button>
      <button class="tab-btn" data-tab-btn="tecnico">Avanzado</button>
    </div>

    <div class="grid tab-section active" data-tab="inicio">
      <div class="card col-3 kpi"><div class="l">Total tareas</div><div class="v">{{ total_tasks }}</div></div>
      <div class="card col-3 kpi"><div class="l">Modelos activos</div><div class="v">{{ total_models }}</div></div>
      <div class="card col-3 kpi"><div class="l">Tokens acumulados</div><div class="v">{{ total_tokens }}</div></div>
      <div class="card col-3 kpi"><div class="l">Cron registradas</div><div class="v">{{ cron_rows|length }}</div></div>

      <div class="card col-3 kpi"><div class="l">Equity (USD)</div><div class="v">{{ '%.2f'|format(portfolio_equity_usd) }}</div></div>
      <div class="card col-3 kpi"><div class="l">Cash (USD)</div><div class="v">{{ '%.2f'|format(portfolio_cash_usd) }}</div></div>
      <div class="card col-3 kpi"><div class="l">Market Value</div><div class="v">{{ '%.2f'|format(portfolio_market_value_usd) }}</div></div>
      <div class="card col-3 kpi"><div class="l">Posiciones</div><div class="v">{{ portfolio_positions|length }}</div></div>

      <div class="card col-4">
        <h2>Tareas por estado</h2>
        <table>
          <tr><th>Estado</th><th>Cantidad</th></tr>
          {% for r in task_counts %}
            {% set st = r.status %}
            {% if st == 'pending' %}{% set st_es = 'pendiente' %}
            {% elif st == 'running' %}{% set st_es = 'en curso' %}
            {% elif st == 'done' %}{% set st_es = 'hecha' %}
            {% elif st == 'blocked' %}{% set st_es = 'bloqueada' %}
            {% elif st == 'cancelled' %}{% set st_es = 'cancelada' %}
            {% else %}{% set st_es = st %}{% endif %}
            <tr><td><span class="badge {{ r.status }}">{{ st_es }}</span></td><td>{{ r.c }}</td></tr>
          {% endfor %}
          {% if task_counts|length == 0 %}<tr><td colspan="2">Sin datos</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-8">
        <h2>Tokens por modelo</h2>
        <table>
          <tr><th>Modelo</th><th>In</th><th>Out</th><th>Total</th></tr>
          {% for r in token_by_model %}
            <tr><td>{{ r.model }}</td><td>{{ r.tin or 0 }}</td><td>{{ r.tout or 0 }}</td><td>{{ r.total or 0 }}</td></tr>
          {% endfor %}
          {% if token_by_model|length == 0 %}<tr><td colspan="4">Sin datos</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Tareas de agentes (resumen r√°pido)</h2>
        <table>
          <tr><th>ID</th><th>Estado</th><th>Agente</th><th>T√≠tulo</th><th>Actualizado</th></tr>
          {% for r in recent_tasks[:8] %}
            {% set st = r.status %}
            {% if st == 'pending' %}{% set st_es = 'pendiente' %}
            {% elif st == 'running' %}{% set st_es = 'en curso' %}
            {% elif st == 'done' %}{% set st_es = 'hecha' %}
            {% elif st == 'blocked' %}{% set st_es = 'bloqueada' %}
            {% elif st == 'cancelled' %}{% set st_es = 'cancelada' %}
            {% else %}{% set st_es = st %}{% endif %}
            <tr>
              <td>{{ r.task_id }}</td>
              <td><span class="badge {{ r.status }}">{{ st_es }}</span></td>
              <td>{{ r.assigned_to }}</td>
              <td>{{ r.title }}</td>
              <td>{{ r.updated_at }}</td>
            </tr>
          {% endfor %}
          {% if recent_tasks|length == 0 %}<tr><td colspan="5">Sin tareas todav√≠a</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Historial de commits (√∫ltimos cambios)</h2>
        <table>
          <tr><th>Commit</th><th>Fecha</th><th>Mensaje</th></tr>
          {% for c in commits %}
            <tr><td><code>{{ c.hash }}</code></td><td>{{ c.date }}</td><td>{{ c.msg }}</td></tr>
          {% endfor %}
          {% if commits|length == 0 %}<tr><td colspan="3">Sin datos de git</td></tr>{% endif %}
        </table>
      </div>

    </div>

    <div class="grid tab-section" data-tab="cartera">
      <div class="card col-12">
        <h2>Cartera (USD) ‚Äî vista simple</h2>
        <table>
          <tr><th>Capital inicial</th><th>Cash</th><th>Valor posiciones</th><th>Equity</th><th>N¬∫ posiciones</th></tr>
          <tr>
            <td>{{ portfolio.capital_initial_usd if portfolio.capital_initial_usd is not none else '-' }}</td>
            <td>{{ '%.2f'|format(portfolio_cash_usd) }}</td>
            <td>{{ '%.2f'|format(portfolio_market_value_usd) }}</td>
            <td>{{ '%.2f'|format(portfolio_equity_usd) }}</td>
            <td>{{ portfolio_positions|length }}</td>
          </tr>
        </table>
      </div>

      <div class="card col-12">
        <h2>√ìrdenes pendientes</h2>
        <table>
          <tr><th>ID</th><th>Ticker</th><th>Estado</th><th>Score</th><th>Creada</th></tr>
          {% for o in orders_pending %}
            <tr><td>{{ o.id }}</td><td>{{ o.ticker }}</td><td>{{ o.state }}</td><td>{{ o.score }}</td><td>{{ o.created_at }}</td></tr>
          {% endfor %}
          {% if orders_pending|length == 0 %}<tr><td colspan="5">Sin √≥rdenes pendientes</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>√ìrdenes completadas</h2>
        <table>
          <tr><th>ID</th><th>Ticker</th><th>Resultado</th><th>Cerrada</th></tr>
          {% for o in orders_completed %}
            <tr><td>{{ o.id }}</td><td>{{ o.ticker }}</td><td>{{ o.result or '-' }}</td><td>{{ o.closed_at or '-' }}</td></tr>
          {% endfor %}
          {% if orders_completed|length == 0 %}<tr><td colspan="4">Sin √≥rdenes completadas</td></tr>{% endif %}
        </table>
      </div>
    </div>

    <div class="grid tab-section" data-tab="fuentes">
      <div class="card col-12">
        <h2>Se√±ales gratis (snapshot)</h2>
        <div class="muted" style="margin-bottom:8px">Generado: {{ signals.generated_at or 'N/D' }} {% if signals_stale %}<span style="color:#ffb4b4">(desactualizado)</span>{% endif %}</div>
        <div class="grid" style="grid-template-columns: repeat(12,1fr); gap:10px;">
          <div class="col-4" style="grid-column: span 4;">
            <h2>Macro (FRED)</h2>
            <table>
              <tr><th>Serie</th><th>√öltimo</th><th>Fecha</th></tr>
              {% for m in signals.macro[:6] %}
                <tr><td>{{ m.series }}</td><td>{{ m.latest_value or '-' }}</td><td>{{ m.latest_date or '-' }}</td></tr>
              {% endfor %}
            </table>
          </div>
          <div class="col-4" style="grid-column: span 4;">
            <h2>Market (Yahoo)</h2>
            <table>
              <tr><th>Ticker</th><th>Precio</th><th>Exch</th></tr>
              {% for s in signals.market[:8] %}
                <tr><td>{{ s.ticker }}</td><td>{{ s.regularMarketPrice or '-' }}</td><td>{{ s.exchange or '-' }}</td></tr>
              {% endfor %}
            </table>
          </div>
          <div class="col-4" style="grid-column: span 4;">
            <h2>News (RSS)</h2>
            <table>
              <tr><th>Titular</th></tr>
              {% for feed in signals.news[:4] %}
                {% for item in feed['items'][:2] %}
                  <tr><td><a href="{{ item.link }}" target="_blank" style="color:#9ec5ff">{{ item.title_es or item.title }}</a></td></tr>
                {% endfor %}
              {% endfor %}
            </table>
          </div>

          <div class="col-12" style="grid-column: span 12;">
            <h2>Se√±al social web (Stocktwits)</h2>
            <table>
              <tr><th>S√≠mbolo</th><th>Mensajes</th><th>Bullish</th><th>Bearish</th><th>Score Sentimiento</th></tr>
              {% for s in signals.social[:8] %}
                <tr>
                  <td>{{ s.symbol }}</td>
                  <td>{{ s.messages_checked or '-' }}</td>
                  <td>{{ s.bullish or 0 }}</td>
                  <td>{{ s.bearish or 0 }}</td>
                  <td>{{ s.sentiment_score if s.sentiment_score is not none else '-' }}</td>
                </tr>
              {% endfor %}
              {% if signals.social is not defined or signals.social|length == 0 %}
                <tr><td colspan="5">Sin datos sociales</td></tr>
              {% endif %}
            </table>
          </div>

          <div class="col-12" style="grid-column: span 12;">
            <h2>Earnings calendar (gratis)</h2>
            <table>
              <tr><th>S√≠mbolo</th><th>Fuente</th><th>Fecha</th><th>EPS Est.</th><th>EPS Real</th><th>Revenue Est.</th><th>Revenue Real</th></tr>
              {% for e in signals.earnings[:12] %}
                <tr>
                  <td>{{ e.symbol }}</td><td>{{ e.source }}</td><td>{{ e.date or '-' }}</td>
                  <td>{{ e.eps_estimate if e.eps_estimate is not none else '-' }}</td>
                  <td>{{ e.eps_actual if e.eps_actual is not none else '-' }}</td>
                  <td>{{ e.revenue_estimate if e.revenue_estimate is not none else '-' }}</td>
                  <td>{{ e.revenue_actual if e.revenue_actual is not none else '-' }}</td>
                </tr>
              {% endfor %}
              {% if signals.earnings is not defined or signals.earnings|length == 0 %}
                <tr><td colspan="7">Sin datos de earnings (faltan API keys o no hay eventos hoy)</td></tr>
              {% endif %}
            </table>
          </div>
        </div>
      </div>

    </div>

    <div class="grid tab-section" data-tab="agentes">
      <div class="card col-12">
        <h2>Qu√© hacen los agentes (explicado simple)</h2>
        <p class="muted">Cada agente tiene un trabajo: uno mira macro, otro noticias, otro t√©cnico y otro riesgo. Alpha Scout junta todo y decide estado WATCH/READY/TRIGGERED.</p>
        <table>
          <tr><th>Agente</th><th>Rol</th><th>Modelo</th><th>Motivo</th></tr>
          {% for a in agents_runtime %}
            <tr><td>{{ a.id }}</td><td>{{ a.role }}</td><td>{{ a.model }}</td><td>{{ a.why }}</td></tr>
          {% endfor %}
          {% if agents_runtime|length == 0 %}<tr><td colspan="4">Sin configuraci√≥n de agentes</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Piloto autom√°tico</h2>
        <p class="muted">Funciona solo por cron. El bot√≥n es solo de prueba/manual.</p>
        <form method="post" action="/autopilot/run" style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
          <label class="muted">Ejecutar ahora con score ‚â•</label>
          <input name="threshold" type="number" min="0" max="100" value="60" style="width:90px;padding:8px;border-radius:8px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff" />
          <input name="assigned_to" value="alpha-scout" style="padding:8px;border-radius:8px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff" />
          <button type="submit" style="padding:8px 12px;border-radius:8px;border:1px solid #35518a;background:#1d3b72;color:#fff;cursor:pointer">Ejecutar piloto autom√°tico</button>
        </form>
        <table>
          <tr><th>Hora</th><th>Umbral</th><th>Agente</th><th>Top vistos</th><th>Tareas</th><th>√ìrdenes</th></tr>
          {% for a in autopilot_log[:8] %}
            <tr><td>{{ a.ts }}</td><td>{{ a.threshold }}</td><td>{{ a.assigned_to }}</td><td>{{ a.top_count }}</td><td>{{ a.created_tasks }}</td><td>{{ a.created_orders or 0 }}</td></tr>
          {% endfor %}
          {% if autopilot_log|length == 0 %}<tr><td colspan="6">Sin ejecuciones todav√≠a</td></tr>{% endif %}
        </table>
      </div>

    </div>

    <div class="grid tab-section" data-tab="oportunidades">
      <div class="card col-12">
        <h2>Top oportunidades (score MVP)</h2>
        <table>
          <tr><th>Ticker</th><th>Estado</th><th>Earnings</th><th>Score final</th><th>T√©cnico</th><th>Asimetr√≠a</th><th>Ajuste macro</th><th>Social</th><th>Convergencia</th><th>RSI14</th><th>EMA20</th><th>EMA50</th><th>RelVol</th><th>Breakout20</th><th>5D %</th><th>20D %</th><th>Razones</th></tr>
          {% set top_ops = signals.top_opportunities if signals.top_opportunities is defined else [] %}
          {% for o in top_ops[:5] %}
            <tr>
              <td>{{ o.ticker }}</td>
              <td>{{ o.state or 'WATCH' }}</td>
              <td>{{ o.earnings_label or 'No Data' }}</td>
              <td><strong>{{ o.score_final if o.score_final is not none else o.score }}</strong></td>
              <td>{{ o.score_tech if o.score_tech is not none else '-' }}</td>
              <td>{{ o.score_asymmetry if o.score_asymmetry is not none else '-' }}</td>
              <td>{{ o.score_macro_adj if o.score_macro_adj is not none else '-' }}</td>
              <td>{{ o.score_social if o.score_social is not none else '-' }}</td>
              <td>{{ o.convergence_count if o.convergence_count is not none else '-' }}</td>
              <td>{{ o.rsi14 if o.rsi14 is not none else '-' }}</td>
              <td>{{ o.ema20 if o.ema20 is not none else '-' }}</td>
              <td>{{ o.ema50 if o.ema50 is not none else '-' }}</td>
              <td>{{ o.rel_volume if o.rel_volume is not none else '-' }}</td>
              <td>{{ 'S√≠' if o.breakout_20 else 'No' }}</td>
              <td>{{ o.chg_5d_pct if o.chg_5d_pct is not none else '-' }}</td>
              <td>{{ o.chg_20d_pct if o.chg_20d_pct is not none else '-' }}</td>
              <td>{{ (o.reasons or [])|join(', ') }}</td>
            </tr>
          {% endfor %}
          {% if top_ops|length == 0 %}
            <tr><td colspan="17">Sin oportunidades calculadas todav√≠a</td></tr>
          {% endif %}
        </table>
      </div>

    </div>

    <div class="grid tab-section" data-tab="tecnico">
      <div class="card col-12">
        <h2>Avanzado (solo para ajustes manuales)</h2>
        <p class="muted">Esta pesta√±a es opcional. Si no quieres tocar nada t√©cnico, ign√≥rala.</p>
        <h2>Override manual (solo si quieres forzar una tarea)</h2>
        <form method="post" action="/tasks/create" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 120px;gap:8px;align-items:end">
          <div>
            <label class="muted">T√≠tulo</label>
            <input name="title" required style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff" placeholder="Ej: Vigilar ruptura de NVDA con volumen" />
          </div>
          <div>
            <label class="muted">Agente</label>
            <input name="assigned_to" value="alpha-scout" style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff" />
          </div>
          <div>
            <label class="muted">Convicci√≥n</label>
            <input name="conviction" type="number" min="1" max="5" value="3" style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff" />
          </div>
          <div>
            <label class="muted">Prioridad</label>
            <select name="priority" style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff">
              <option value="alta">alta</option>
              <option value="media" selected>media</option>
              <option value="baja">baja</option>
            </select>
          </div>
          <button type="submit" style="padding:10px;border-radius:10px;border:1px solid #35518a;background:#1d3b72;color:white;cursor:pointer">A√±adir</button>
        </form>
      </div>

      <div class="card col-12">
        <h2>Tareas de agentes (√∫ltimas)</h2>
        <table>
          <tr><th>ID</th><th>Estado</th><th>Prioridad</th><th>Asign√≥</th><th>Agente</th><th>T√≠tulo</th><th>Convicci√≥n</th><th>Actualizado</th><th>Acciones</th></tr>
          {% for r in recent_tasks %}
            {% set conv = '-' %}
            {% if r.details and '[conviction:' in r.details %}
              {% set conv = r.details.split('[conviction:')[1].split(']')[0] %}
            {% endif %}
            <tr>
              <td>{{ r.task_id }}</td>
              {% set st = r.status %}
              {% if st == 'pending' %}{% set st_es = 'pendiente' %}
              {% elif st == 'running' %}{% set st_es = 'en curso' %}
              {% elif st == 'done' %}{% set st_es = 'hecha' %}
              {% elif st == 'blocked' %}{% set st_es = 'bloqueada' %}
              {% elif st == 'cancelled' %}{% set st_es = 'cancelada' %}
              {% else %}{% set st_es = st %}{% endif %}
              <td><span class="badge {{ r.status }}">{{ st_es }}</span></td>
              <td>{{ r.priority or 'media' }}</td>
              <td>{{ r.assigned_by }}</td>
              <td>{{ r.assigned_to }}</td>
              <td>{{ r.title }}</td>
              <td>{{ conv }}</td>
              <td>{{ r.updated_at }}</td>
              <td>
                <form method="post" action="/tasks/status" style="display:flex;gap:6px;flex-wrap:wrap">
                  <input type="hidden" name="task_id" value="{{ r.task_id }}" />
                  <button name="status" value="running" style="padding:4px 8px;border-radius:8px;border:1px solid #2a3a5b;background:#0c3147;color:#8ad4ff;cursor:pointer">En curso</button>
                  <button name="status" value="done" style="padding:4px 8px;border-radius:8px;border:1px solid #2a3a5b;background:#133a22;color:#8ee6b0;cursor:pointer">Hecha</button>
                  <button name="status" value="blocked" style="padding:4px 8px;border-radius:8px;border:1px solid #2a3a5b;background:#4b1f1f;color:#ffb4b4;cursor:pointer">Bloqueada</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          {% if recent_tasks|length == 0 %}<tr><td colspan="9">Sin datos</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Cron registradas</h2>
        <table>
          <tr><th>Nombre</th><th>Cron</th><th>Activa</th><th>Owner</th><th>Task Ref</th><th>Actualizado</th></tr>
          {% for r in cron_rows %}
            <tr>
              <td>{{ r.name }}</td>
              <td>{{ r.cron_expr }}</td>
              <td>{{ 's√≠' if r.active == 1 else 'no' }}</td>
              <td>{{ r.owner_user_id }}</td>
              <td>{{ r.task_ref }}</td>
              <td>{{ r.updated_at }}</td>
            </tr>
          {% endfor %}
          {% if cron_rows|length == 0 %}<tr><td colspan="6">Sin datos</td></tr>{% endif %}
        </table>
      </div>
    </div>

    <div class="foot">√öltima actualizaci√≥n: <span id="ts"></span></div>
  </div>
  <script>
    document.getElementById('ts').textContent = new Date().toLocaleString();

    const btns = document.querySelectorAll('[data-tab-btn]');
    const tabs = document.querySelectorAll('[data-tab]');

    function activateTab(name){
      btns.forEach(x => x.classList.remove('active'));
      tabs.forEach(t => t.classList.remove('active'));
      const btn = document.querySelector(`[data-tab-btn="${name}"]`);
      const pane = document.querySelector(`[data-tab="${name}"]`);
      if(btn) btn.classList.add('active');
      if(pane) pane.classList.add('active');
    }

    const savedTab = localStorage.getItem('dashboard_active_tab') || 'inicio';
    activateTab(savedTab);

    btns.forEach(b => {
      b.addEventListener('click', () => {
        const target = b.getAttribute('data-tab-btn');
        localStorage.setItem('dashboard_active_tab', target);
        activateTab(target);
      });
    });

    setTimeout(() => location.reload(), 30000);
  </script>
</body>
</html>
