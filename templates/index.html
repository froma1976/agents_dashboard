<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Ops Dashboard</title>
  <style>
    :root{
      --bg:#070b14; --panel:#111827cc; --line:#26324d; --txt:#eaf0ff; --muted:#93a4c9;
      --ok:#22c55e; --warn:#f59e0b; --run:#38bdf8; --bad:#ef4444; --off:#94a3b8;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--txt); font-family:Inter,Segoe UI,Arial,sans-serif;
      background: radial-gradient(1200px 500px at 10% -10%, #1d2e5c 0%, transparent 60%),
                  radial-gradient(900px 400px at 90% -20%, #153d4a 0%, transparent 55%),
                  var(--bg);
    }
    .wrap{max-width:1280px;margin:24px auto;padding:0 16px}
    .top{display:flex;align-items:end;justify-content:space-between;gap:12px;margin-bottom:14px}
    h1{margin:0;font-size:28px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--panel);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 10px 30px #00000033}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .v{font-size:28px;font-weight:700}
    .kpi .l{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    h2{margin:0 0 10px;font-size:15px;color:#c6d3f2}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid #2a3a5b;padding:8px;text-align:left}
    th{color:#b9c8ee;font-weight:600}
    .badge{display:inline-block;padding:3px 9px;border-radius:999px;font-size:12px;font-weight:600}
    .ok{background:#133a22;color:#8ee6b0}
    .no{background:#4b1f1f;color:#ffb4b4}
    .warn{background:#3b2c0a;color:#ffd27a}
    .pending{background:#3b2c0a;color:#ffd27a}.running{background:#0c3147;color:#8ad4ff}
    .done{background:#133a22;color:#8ee6b0}.blocked{background:#4b1f1f;color:#ffb4b4}
    .cancelled{background:#374151;color:#d1d5db}
    .right{display:flex;gap:8px;align-items:center}
    .pill{border:1px solid var(--line);padding:5px 10px;border-radius:999px;font-size:12px;color:#c7d4f5}
    .dot{width:8px;height:8px;border-radius:50%;display:inline-block;background:var(--ok);margin-right:6px}
    .foot{margin-top:10px;font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
    .tab-btn{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#0d1423;color:#c7d4f5;cursor:pointer}
    .tab-btn.active{background:#1d3b72;border-color:#35518a;color:#fff}
    .tab-section{display:none}
    .tab-section.active{display:grid}
    .expert-only{display:none}
    body.expert .expert-only{display:inline-flex}
    .simple-note{display:inline-flex}
    body.expert .simple-note{display:none}
    @media (max-width:960px){.col-3,.col-4,.col-6,.col-8{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>üìä Dashboard Cerebro de Agentes</h1>
        <div class="muted">Control centralizado de tareas, cron, se√±ales y cartera</div>
      </div>
      <div class="right">
        <div class="pill"><span class="dot"></span>en l√≠nea</div>
        <div class="pill">auto-actualizaci√≥n: 30s</div>
        <div class="pill" style="{% if signals_stale %}border-color:#7a2e2e;color:#ffb4b4;background:#311;{% endif %}">se√±ales: {% if signals.freshness_min is not none %}hace {{ signals.freshness_min }} min{% else %}N/D{% endif %}{% if signals_stale %} ‚ö† stale{% endif %}</div>
        <form method="post" action="/signals/refresh" style="margin:0">
          <button type="submit" class="pill" style="background:#1d3b72;border-color:#35518a;color:#fff;cursor:pointer">Actualizar se√±ales</button>
        </form>
      </div>
    </div>

    {% set total_tasks = 0 %}
    {% for r in task_counts %}{% set total_tasks = total_tasks + r.c %}{% endfor %}
    {% set total_models = token_by_model|length %}
    {% set total_tokens = 0 %}
    {% for r in token_by_model %}{% set total_tokens = total_tokens + (r.total or 0) %}{% endfor %}

    <div class="tabs">
      <button class="tab-btn active" data-tab-btn="inicio">Inicio</button>
      <button class="tab-btn" data-tab-btn="oportunidades">Oportunidades</button>
      <button class="tab-btn" data-tab-btn="cartera">Cartera</button>
      <button class="tab-btn expert-only" data-tab-btn="agentes">Agentes</button>
      <button class="tab-btn expert-only" data-tab-btn="fuentes">Fuentes</button>
      <button class="tab-btn expert-only" data-tab-btn="tecnico">Avanzado</button>
      <span class="pill simple-note">Modo cliente activo</span>
      <button id="modeToggle" class="tab-btn" type="button">Modo experto: OFF</button>
    </div>

    <div class="grid tab-section active" data-tab="inicio">
      <div class="card col-12">
        <h2>Sem√°foro global de mercado</h2>
        <p>
          Estado hoy: <span class="badge {{ market_today.color }}">{{ market_today.label }}</span>
          <span class="muted"> ‚Äî {{ market_today.reason }}</span>
        </p>
      </div>

      <div class="card col-12">
        <h2>Qu√© hacer hoy (resumen simple)</h2>
        {% set top_ops = signals.top_opportunities if signals.top_opportunities is defined else [] %}
        {% set top = top_ops[0] if top_ops|length > 0 else None %}
        <p>
          {% if top %}
            Mejor oportunidad actual: <strong>{{ top.ticker }}</strong> (estado: <strong>{{ top.state or 'WATCH' }}</strong>, score: <strong>{{ top.score_final or top.score }}</strong>). 
            Acci√≥n sugerida: <strong>{% if (top.state or 'WATCH') == 'TRIGGERED' %}ejecuci√≥n simulada{% elif (top.state or 'WATCH') == 'READY' %}vigilar de cerca{% else %}esperar confirmaci√≥n{% endif %}</strong>.
          {% else %}
            Sin oportunidades claras ahora. Acci√≥n sugerida: esperar actualizaci√≥n.
          {% endif %}
        </p>
      </div>

      <div class="card col-3 kpi"><div class="l">Total tareas</div><div class="v">{{ total_tasks }}</div></div>
      <div class="card col-3 kpi"><div class="l">Modelos activos</div><div class="v">{{ total_models }}</div></div>
      <div class="card col-3 kpi"><div class="l">Tokens acumulados</div><div class="v">{{ total_tokens }}</div></div>
      <div class="card col-3 kpi"><div class="l">Cron registradas</div><div class="v">{{ cron_rows|length }}</div></div>

      <div class="card col-3 kpi"><div class="l">Equity (USD)</div><div class="v">{{ '%.2f'|format(portfolio_equity_usd) }}</div></div>
      <div class="card col-3 kpi"><div class="l">Cash (USD)</div><div class="v">{{ '%.2f'|format(portfolio_cash_usd) }}</div></div>
      <div class="card col-3 kpi"><div class="l">Market Value</div><div class="v">{{ '%.2f'|format(portfolio_market_value_usd) }}</div></div>
      <div class="card col-3 kpi"><div class="l">Posiciones</div><div class="v">{{ portfolio_positions|length }}</div></div>

      <div class="card col-4">
        <h2>Tareas por estado</h2>
        <table>
          <tr><th>Estado</th><th>Cantidad</th></tr>
          {% for r in task_counts %}
            {% set st = r.status %}
            {% if st == 'pending' %}{% set st_es = 'pendiente' %}
            {% elif st == 'running' %}{% set st_es = 'en curso' %}
            {% elif st == 'done' %}{% set st_es = 'hecha' %}
            {% elif st == 'blocked' %}{% set st_es = 'bloqueada' %}
            {% elif st == 'cancelled' %}{% set st_es = 'cancelada' %}
            {% else %}{% set st_es = st %}{% endif %}
            <tr><td><span class="badge {{ r.status }}">{{ st_es }}</span></td><td>{{ r.c }}</td></tr>
          {% endfor %}
          {% if task_counts|length == 0 %}<tr><td colspan="2">Sin datos</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-8">
        <h2>Tokens por modelo</h2>
        <table>
          <tr><th>Modelo</th><th>In</th><th>Out</th><th>Total</th></tr>
          {% for r in token_by_model %}
            <tr><td>{{ r.model }}</td><td>{{ r.tin or 0 }}</td><td>{{ r.tout or 0 }}</td><td>{{ r.total or 0 }}</td></tr>
          {% endfor %}
          {% if token_by_model|length == 0 %}<tr><td colspan="4">Sin datos</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Qu√© est√°n haciendo los agentes (en lenguaje normal)</h2>
        <table>
          <tr><th>Estado</th><th>Agente</th><th>Qu√© est√° haciendo</th><th>Actualizado</th></tr>
          {% for r in recent_tasks[:8] %}
            {% set st = r.status %}
            {% if st == 'pending' %}{% set st_es = 'en espera' %}
            {% elif st == 'running' %}{% set st_es = 'trabajando' %}
            {% elif st == 'done' %}{% set st_es = 'terminado' %}
            {% elif st == 'blocked' %}{% set st_es = 'bloqueado' %}
            {% elif st == 'cancelled' %}{% set st_es = 'cancelado' %}
            {% else %}{% set st_es = st %}{% endif %}

            {% set t = (r.title or '')|lower %}
            {% if 'qqq' in t %}
              {% set tarea_humana = 'Analizando el principal ETF tecnol√≥gico de EE.UU.' %}
            {% elif 'spy' in t %}
              {% set tarea_humana = 'Analizando el √≠ndice general del mercado de EE.UU.' %}
            {% elif 'iwm' in t %}
              {% set tarea_humana = 'Analizando small caps de EE.UU. para detectar impulso.' %}
            {% elif 'nvda' in t %}
              {% set tarea_humana = 'Analizando NVIDIA por posible oportunidad.' %}
            {% elif '[auto]' in t or 'ejecutar plan' in t %}
              {% set tarea_humana = 'Evaluando si conviene abrir una operaci√≥n simulada.' %}
            {% else %}
              {% set tarea_humana = 'Revisando se√±ales del mercado y riesgo.' %}
            {% endif %}

            <tr>
              <td><span class="badge {{ r.status }}">{{ st_es }}</span></td>
              <td>{{ r.assigned_to }}</td>
              <td>{{ tarea_humana }}</td>
              <td>{{ r.updated_at }}</td>
            </tr>
          {% endfor %}
          {% if recent_tasks|length == 0 %}<tr><td colspan="4">Sin tareas todav√≠a</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12 expert-only">
        <h2>Historial de commits (√∫ltimos cambios)</h2>
        <table>
          <tr><th>Commit</th><th>Fecha</th><th>Mensaje</th></tr>
          {% for c in commits %}
            <tr><td><code>{{ c.hash }}</code></td><td>{{ c.date }}</td><td>{{ c.msg }}</td></tr>
          {% endfor %}
          {% if commits|length == 0 %}<tr><td colspan="3">Sin datos de git</td></tr>{% endif %}
        </table>
      </div>

    </div>

    <div class="grid tab-section" data-tab="cartera">
      <div class="card col-12">
        <h2>Cartera (USD) ‚Äî vista simple</h2>
        <table>
          <tr><th>Capital inicial</th><th>Cash</th><th>Valor posiciones</th><th>Equity</th><th>N¬∫ posiciones</th></tr>
          <tr>
            <td>{{ portfolio.capital_initial_usd if portfolio.capital_initial_usd is not none else '-' }}</td>
            <td>{{ '%.2f'|format(portfolio_cash_usd) }}</td>
            <td>{{ '%.2f'|format(portfolio_market_value_usd) }}</td>
            <td>{{ '%.2f'|format(portfolio_equity_usd) }}</td>
            <td>{{ portfolio_positions|length }}</td>
          </tr>
        </table>
      </div>

      <div class="card col-12">
        <h2>KPIs de rendimiento (simulado)</h2>
        {% set kpi = orders_kpi|default({'pending':0,'closed':0,'wins':0,'losses':0,'neutral':0,'win_rate':0}) %}
        <table>
          <tr><th>√ìrdenes pendientes</th><th>√ìrdenes cerradas</th><th>Ganadas</th><th>Perdidas</th><th>Neutrales</th><th>Win Rate</th><th>Expectancy (R)</th><th>Max Drawdown (R)</th></tr>
          <tr>
            <td>{{ kpi.pending }}</td>
            <td>{{ kpi.closed }}</td>
            <td>{{ kpi.wins }}</td>
            <td>{{ kpi.losses }}</td>
            <td>{{ kpi.neutral }}</td>
            <td>{{ kpi.win_rate }}%</td>
            <td>{{ kpi.expectancy_r }}</td>
            <td>{{ kpi.max_drawdown_r }}</td>
          </tr>
        </table>
      </div>

      <div class="card col-12">
        <h2>Drawdown visual (equity en R)</h2>
        <svg id="equityChart" viewBox="0 0 600 180" style="width:100%;height:180px;border:1px solid #2a3a5b;border-radius:10px;background:#0d1423"></svg>
        <div class="muted">Curva acumulada basada en resultados cerrados (R m√∫ltiplos).</div>
      </div>

      <div class="card col-12">
        <h2>√ìrdenes pendientes</h2>
        <table>
          <tr><th>ID</th><th>Ticker</th><th>Estado</th><th>Score</th><th>Entrada</th><th>Target</th><th>Stop</th><th>Creada</th><th>Acci√≥n</th></tr>
          {% for o in orders_pending %}
            <tr>
              <td>{{ o.id }}</td><td>{{ o.ticker }}</td><td>{{ o.state }}</td><td>{{ o.score }}</td><td>{{ o.entry_price or '-' }}</td><td>{{ o.target_price or '-' }}</td><td>{{ o.stop_price or '-' }}</td><td>{{ o.created_at }}</td>
              <td>
                <form method="post" action="/orders/complete" style="display:flex;gap:6px;align-items:center">
                  <input type="hidden" name="order_id" value="{{ o.id }}" />
                  <select name="result" style="padding:6px;border-radius:8px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff">
                    <option value="ganada">ganada</option>
                    <option value="neutral">neutral</option>
                    <option value="perdida">perdida</option>
                  </select>
                  <button type="submit" style="padding:6px 10px;border-radius:8px;border:1px solid #35518a;background:#1d3b72;color:#fff;cursor:pointer">Completar</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          {% if orders_pending|length == 0 %}<tr><td colspan="9">Sin √≥rdenes pendientes</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>√ìrdenes completadas</h2>
        <table>
          <tr><th>ID</th><th>Ticker</th><th>Resultado</th><th>Cerrada</th></tr>
          {% for o in orders_completed %}
            <tr><td>{{ o.id }}</td><td>{{ o.ticker }}</td><td>{{ o.result or '-' }}</td><td>{{ o.closed_at or '-' }}</td></tr>
          {% endfor %}
          {% if orders_completed|length == 0 %}<tr><td colspan="4">Sin √≥rdenes completadas</td></tr>{% endif %}
        </table>
      </div>
    </div>

    <div class="grid tab-section" data-tab="fuentes">
      <div class="card col-12">
        <h2>Se√±ales gratis (snapshot)</h2>
        <div class="muted" style="margin-bottom:8px">Generado: {{ signals.generated_at or 'N/D' }} {% if signals_stale %}<span style="color:#ffb4b4">(desactualizado)</span>{% endif %}</div>
        <div class="grid" style="grid-template-columns: repeat(12,1fr); gap:10px;">
          <div class="col-4" style="grid-column: span 4;">
            <h2>Macro (FRED)</h2>
            <table>
              <tr><th>Serie</th><th>√öltimo</th><th>Fecha</th></tr>
              {% for m in signals.macro[:6] %}
                <tr><td>{{ m.series }}</td><td>{{ m.latest_value or '-' }}</td><td>{{ m.latest_date or '-' }}</td></tr>
              {% endfor %}
            </table>
          </div>
          <div class="col-4" style="grid-column: span 4;">
            <h2>Market (Yahoo)</h2>
            <table>
              <tr><th>Ticker</th><th>Precio</th><th>Exch</th></tr>
              {% for s in signals.market[:8] %}
                <tr><td>{{ s.ticker }}</td><td>{{ s.regularMarketPrice or '-' }}</td><td>{{ s.exchange or '-' }}</td></tr>
              {% endfor %}
            </table>
          </div>
          <div class="col-4" style="grid-column: span 4;">
            <h2>News (RSS)</h2>
            <table>
              <tr><th>Titular</th></tr>
              {% for feed in signals.news[:4] %}
                {% for item in feed['items'][:2] %}
                  <tr><td><a href="{{ item.link }}" target="_blank" style="color:#9ec5ff">{{ item.title_es or item.title }}</a></td></tr>
                {% endfor %}
              {% endfor %}
            </table>
          </div>

          <div class="col-12" style="grid-column: span 12;">
            <h2>Se√±al social web (Stocktwits)</h2>
            <table>
              <tr><th>S√≠mbolo</th><th>Mensajes</th><th>Bullish</th><th>Bearish</th><th>Score Sentimiento</th></tr>
              {% for s in signals.social[:8] %}
                <tr>
                  <td>{{ s.symbol }}</td>
                  <td>{{ s.messages_checked or '-' }}</td>
                  <td>{{ s.bullish or 0 }}</td>
                  <td>{{ s.bearish or 0 }}</td>
                  <td>{{ s.sentiment_score if s.sentiment_score is not none else '-' }}</td>
                </tr>
              {% endfor %}
              {% if signals.social is not defined or signals.social|length == 0 %}
                <tr><td colspan="5">Sin datos sociales</td></tr>
              {% endif %}
            </table>
          </div>

          <div class="col-12" style="grid-column: span 12;">
            <h2>Earnings calendar (gratis)</h2>
            <table>
              <tr><th>S√≠mbolo</th><th>Fuente</th><th>Fecha</th><th>EPS Est.</th><th>EPS Real</th><th>Revenue Est.</th><th>Revenue Real</th></tr>
              {% for e in signals.earnings[:12] %}
                <tr>
                  <td>{{ e.symbol }}</td><td>{{ e.source }}</td><td>{{ e.date or '-' }}</td>
                  <td>{{ e.eps_estimate if e.eps_estimate is not none else '-' }}</td>
                  <td>{{ e.eps_actual if e.eps_actual is not none else '-' }}</td>
                  <td>{{ e.revenue_estimate if e.revenue_estimate is not none else '-' }}</td>
                  <td>{{ e.revenue_actual if e.revenue_actual is not none else '-' }}</td>
                </tr>
              {% endfor %}
              {% if signals.earnings is not defined or signals.earnings|length == 0 %}
                <tr><td colspan="7">Sin datos de earnings (faltan API keys o no hay eventos hoy)</td></tr>
              {% endif %}
            </table>
          </div>
        </div>
      </div>

    </div>

    <div class="grid tab-section" data-tab="agentes">
      <div class="card col-12">
        <h2>Qu√© hacen los agentes (explicado simple)</h2>
        <p class="muted">Cada agente tiene un trabajo: uno mira macro, otro noticias, otro t√©cnico y otro riesgo. Alpha Scout junta todo y decide estado WATCH/READY/TRIGGERED.</p>
        <table>
          <tr><th>Agente</th><th>Rol</th><th>Modelo</th><th>Motivo</th></tr>
          {% for a in agents_runtime %}
            <tr><td>{{ a.id }}</td><td>{{ a.role }}</td><td>{{ a.model }}</td><td>{{ a.why }}</td></tr>
          {% endfor %}
          {% if agents_runtime|length == 0 %}<tr><td colspan="4">Sin configuraci√≥n de agentes</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Estado de agentes (claro y simple)</h2>
        <table>
          <tr><th>Agente</th><th>Modelo</th><th>Estado</th><th>Tiempo de respuesta</th><th>Lectura humana</th></tr>
          {% for h in agents_health %}
            {% set ok = h.ok %}
            {% set estado = 'operativo' if ok else 'revisar' %}
            {% set badge = 'ok' if ok else 'no' %}
            {% set lat = h.latency_s if h.latency_s is not none else '-' %}
            {% if h.model == 'deterministic' %}
              {% set lectura = 'Funciona por reglas fijas (sin IA de texto).' %}
            {% else %}
              {% set lectura = 'IA local respondiendo correctamente.' if ok else 'La IA local no respondi√≥ bien en la √∫ltima prueba.' %}
            {% endif %}
            <tr>
              <td>{{ h.agent }}</td>
              <td>{{ h.model }}</td>
              <td><span class="badge {{ badge }}">{{ estado }}</span></td>
              <td>{{ lat }} s</td>
              <td>{{ lectura }}</td>
            </tr>
          {% endfor %}
          {% if agents_health|length == 0 %}<tr><td colspan="5">Sin datos de salud todav√≠a</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Tokens por agente/proceso</h2>
        <table>
          <tr><th>Actor</th><th>Tokens in</th><th>Tokens out</th><th>Total</th></tr>
          {% for t in token_by_actor %}
            <tr><td>{{ t.actor }}</td><td>{{ t.tin or 0 }}</td><td>{{ t.tout or 0 }}</td><td>{{ t.total or 0 }}</td></tr>
          {% endfor %}
          {% if token_by_actor|length == 0 %}<tr><td colspan="4">Sin datos de tokens por agente todav√≠a</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Matriz de decisi√≥n por agente (por ticker)</h2>
        <p class="muted">As√≠ ves qu√© bloque ha pasado cada activo antes de decidir WATCH/READY/TRIGGERED.</p>
        <table>
          <tr><th>Ticker</th><th>Macro</th><th>Estructural</th><th>Capital</th><th>T√©cnico</th><th>Convergencia</th><th>Estado final</th></tr>
          {% set top_ops = signals.top_opportunities if signals.top_opportunities is defined else [] %}
          {% for o in top_ops[:8] %}
            {% set macro_ok = (o.score_macro_adj if o.score_macro_adj is not none else 0) >= 0 %}
            {% set structural_ok = ((o.fundamental_inflection_score or 0) + (o.catalyst_score or 0) + (o.spinoff_score or 0)) >= 10 %}
            {% set capital_ok = ((o.insider_score or 0) + (o.options_flow_score or 0)) > 0 or ((o.score_social if o.score_social is not none else -999) >= 50) %}
            {% set technical_ok = (o.score_tech or 0) >= 55 %}
            <tr>
              <td>{{ o.ticker }}</td>
              <td><span class="badge {{ 'ok' if macro_ok else 'no' }}">{{ 'OK' if macro_ok else 'NO' }}</span></td>
              <td><span class="badge {{ 'ok' if structural_ok else 'no' }}">{{ 'OK' if structural_ok else 'NO' }}</span></td>
              <td><span class="badge {{ 'ok' if capital_ok else 'no' }}">{{ 'OK' if capital_ok else 'NO' }}</span></td>
              <td><span class="badge {{ 'ok' if technical_ok else 'no' }}">{{ 'OK' if technical_ok else 'NO' }}</span></td>
              <td><span class="badge {{ 'ok' if (o.convergence_count or 0)>=3 else ('warn' if (o.convergence_count or 0)==2 else 'no') }}">{{ o.convergence_count if o.convergence_count is not none else 0 }}/3</span></td>
              <td><span class="badge {{ 'ok' if (o.state or 'WATCH')=='TRIGGERED' else ('warn' if (o.state or 'WATCH')=='READY' else 'no') }}">{{ o.state or 'WATCH' }}</span></td>
            </tr>
          {% endfor %}
          {% if top_ops|length == 0 %}<tr><td colspan="7">Sin datos de oportunidades</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Qu√© est√° haciendo cada agente ahora (en directo)</h2>
        <ul style="margin:0;padding-left:18px;line-height:1.8">
          {% for a in agent_live %}
            <li>{{ a.text }}</li>
          {% endfor %}
          {% if agent_live|length == 0 %}<li>Sin estado en directo todav√≠a.</li>{% endif %}
        </ul>
      </div>

      <div class="card col-12">
        <h2>Actividad autom√°tica reciente (solo lectura)</h2>
        <table>
          <tr><th>Hora</th><th>Top vistos</th><th>Tareas</th><th>√ìrdenes nuevas</th><th>√ìrdenes cerradas</th></tr>
          {% for a in autopilot_log[:8] %}
            <tr><td>{{ a.ts }}</td><td>{{ a.top_count }}</td><td>{{ a.created_tasks }}</td><td>{{ a.created_orders or 0 }}</td><td>{{ a.closed_orders or 0 }}</td></tr>
          {% endfor %}
          {% if autopilot_log|length == 0 %}<tr><td colspan="5">Sin actividad autom√°tica todav√≠a</td></tr>{% endif %}
        </table>
      </div>

    </div>

    <div class="grid tab-section" data-tab="oportunidades">
      <div class="card col-12">
        <h2>Top oportunidades (lectura simple)</h2>
        <table>
          <tr><th>Ticker</th><th>Estado</th><th>Confianza</th><th>Qu√© significa</th><th>Acci√≥n sugerida</th></tr>
          {% set top_ops = signals.top_opportunities if signals.top_opportunities is defined else [] %}
          {% for o in top_ops[:5] %}
            {% set stx = o.state or 'WATCH' %}
            {% set st_es = 'Vigilar' if stx=='WATCH' else ('Casi lista' if stx=='READY' else ('Lista para ejecutar' if stx=='TRIGGERED' else stx)) %}
            {% set conf = o.score_final if o.score_final is not none else o.score %}
            {% if stx == 'TRIGGERED' %}
              {% set accion = 'Preparar ejecuci√≥n simulada inmediata' %}
            {% elif stx == 'READY' %}
              {% set accion = 'Vigilar volumen y confirmaci√≥n para entrar' %}
            {% else %}
              {% set accion = 'Esperar confirmaci√≥n, no entrar a√∫n' %}
            {% endif %}
            <tr>
              <td><strong>{{ o.ticker }}</strong></td>
              <td><span class="badge {{ 'ok' if stx=='TRIGGERED' else ('warn' if stx=='READY' else 'no') }}">{{ 'üü¢ ' if stx=='TRIGGERED' else ('üü° ' if stx=='READY' else 'üî¥ ') }}{{ st_es }}</span></td>
              <td>{{ conf }}/100</td>
              <td>
                {% if o.earnings_label and o.earnings_label != 'No Data' %}{{ o.earnings_label }} ¬∑ {% endif %}
                {% if o.rel_volume and o.rel_volume >= 1.2 %}volumen fuerte{% else %}volumen normal{% endif %}
                ¬∑ {% if o.breakout_20 %}rompiendo m√°ximos recientes{% else %}sin ruptura clara{% endif %}
              </td>
              <td>{{ accion }}</td>
            </tr>
          {% endfor %}
          {% if top_ops|length == 0 %}
            <tr><td colspan="5">Sin oportunidades calculadas todav√≠a</td></tr>
          {% endif %}
        </table>
        <div class="muted" style="margin-top:8px">Tip: en modo experto puedes ver todos los indicadores t√©cnicos detallados.</div>
      </div>

    </div>

    <div class="grid tab-section" data-tab="tecnico">
      <div class="card col-12">
        <h2>Avanzado (solo para ajustes manuales)</h2>
        <p class="muted">Esta pesta√±a es opcional. Si no quieres tocar nada t√©cnico, ign√≥rala.</p>
        <h2>Override manual (solo si quieres forzar una tarea)</h2>
        <form method="post" action="/tasks/create" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 120px;gap:8px;align-items:end">
          <div>
            <label class="muted">T√≠tulo</label>
            <input name="title" required style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff" placeholder="Ej: Vigilar ruptura de NVDA con volumen" />
          </div>
          <div>
            <label class="muted">Agente</label>
            <input name="assigned_to" value="alpha-scout" style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff" />
          </div>
          <div>
            <label class="muted">Convicci√≥n</label>
            <input name="conviction" type="number" min="1" max="5" value="3" style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff" />
          </div>
          <div>
            <label class="muted">Prioridad</label>
            <select name="priority" style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a5b;background:#0d1423;color:#eaf0ff">
              <option value="alta">alta</option>
              <option value="media" selected>media</option>
              <option value="baja">baja</option>
            </select>
          </div>
          <button type="submit" style="padding:10px;border-radius:10px;border:1px solid #35518a;background:#1d3b72;color:white;cursor:pointer">A√±adir</button>
        </form>
      </div>

      <div class="card col-12">
        <h2>Tareas de agentes (√∫ltimas)</h2>
        <table>
          <tr><th>ID</th><th>Estado</th><th>Prioridad</th><th>Asign√≥</th><th>Agente</th><th>T√≠tulo</th><th>Convicci√≥n</th><th>Actualizado</th><th>Acciones</th></tr>
          {% for r in recent_tasks %}
            {% set conv = '-' %}
            {% if r.details and '[conviction:' in r.details %}
              {% set conv = r.details.split('[conviction:')[1].split(']')[0] %}
            {% endif %}
            <tr>
              <td>{{ r.task_id }}</td>
              {% set st = r.status %}
              {% if st == 'pending' %}{% set st_es = 'pendiente' %}
              {% elif st == 'running' %}{% set st_es = 'en curso' %}
              {% elif st == 'done' %}{% set st_es = 'hecha' %}
              {% elif st == 'blocked' %}{% set st_es = 'bloqueada' %}
              {% elif st == 'cancelled' %}{% set st_es = 'cancelada' %}
              {% else %}{% set st_es = st %}{% endif %}
              <td><span class="badge {{ r.status }}">{{ st_es }}</span></td>
              <td>{{ r.priority or 'media' }}</td>
              <td>{{ r.assigned_by }}</td>
              <td>{{ r.assigned_to }}</td>
              <td>{{ r.title }}</td>
              <td>{{ conv }}</td>
              <td>{{ r.updated_at }}</td>
              <td>
                <form method="post" action="/tasks/status" style="display:flex;gap:6px;align-items:center">
                  <input type="hidden" name="task_id" value="{{ r.task_id }}" />
                  {% if r.status == 'pending' %}
                    <button name="status" value="running" style="padding:4px 8px;border-radius:8px;border:1px solid #2a3a5b;background:#0c3147;color:#8ad4ff;cursor:pointer">Pasar a en curso</button>
                  {% elif r.status == 'running' %}
                    <button name="status" value="done" style="padding:4px 8px;border-radius:8px;border:1px solid #2a3a5b;background:#133a22;color:#8ee6b0;cursor:pointer">Marcar hecha</button>
                  {% elif r.status == 'blocked' %}
                    <button name="status" value="running" style="padding:4px 8px;border-radius:8px;border:1px solid #2a3a5b;background:#0c3147;color:#8ad4ff;cursor:pointer">Reanudar (en curso)</button>
                  {% else %}
                    <span class="muted">Sin acciones</span>
                  {% endif %}
                </form>
              </td>
            </tr>
          {% endfor %}
          {% if recent_tasks|length == 0 %}<tr><td colspan="9">Sin datos</td></tr>{% endif %}
        </table>
      </div>

      <div class="card col-12">
        <h2>Cron registradas</h2>
        <table>
          <tr><th>Nombre</th><th>Cron</th><th>Activa</th><th>Owner</th><th>Task Ref</th><th>Actualizado</th></tr>
          {% for r in cron_rows %}
            <tr>
              <td>{{ r.name }}</td>
              <td>{{ r.cron_expr }}</td>
              <td>{{ 's√≠' if r.active == 1 else 'no' }}</td>
              <td>{{ r.owner_user_id }}</td>
              <td>{{ r.task_ref }}</td>
              <td>{{ r.updated_at }}</td>
            </tr>
          {% endfor %}
          {% if cron_rows|length == 0 %}<tr><td colspan="6">Sin datos</td></tr>{% endif %}
        </table>
      </div>
    </div>

    <div class="foot">√öltima actualizaci√≥n: <span id="ts"></span></div>
  </div>
  <script>
    document.getElementById('ts').textContent = new Date().toLocaleString();

    const btns = document.querySelectorAll('[data-tab-btn]');
    const tabs = document.querySelectorAll('[data-tab]');

    function activateTab(name){
      btns.forEach(x => x.classList.remove('active'));
      tabs.forEach(t => t.classList.remove('active'));
      const btn = document.querySelector(`[data-tab-btn="${name}"]`);
      const pane = document.querySelector(`[data-tab="${name}"]`);
      if(btn) btn.classList.add('active');
      if(pane) pane.classList.add('active');
    }

    const savedTab = localStorage.getItem('dashboard_active_tab') || 'inicio';
    activateTab(savedTab);

    const body = document.body;
    const modeBtn = document.getElementById('modeToggle');
    const expertMode = localStorage.getItem('dashboard_expert_mode') === '1';
    if(expertMode){ body.classList.add('expert'); }
    if(modeBtn){ modeBtn.textContent = `Modo experto: ${body.classList.contains('expert') ? 'ON' : 'OFF'}`; }

    btns.forEach(b => {
      b.addEventListener('click', () => {
        const target = b.getAttribute('data-tab-btn');
        localStorage.setItem('dashboard_active_tab', target);
        activateTab(target);
      });
    });

    if(modeBtn){
      modeBtn.addEventListener('click', () => {
        body.classList.toggle('expert');
        localStorage.setItem('dashboard_expert_mode', body.classList.contains('expert') ? '1' : '0');
        modeBtn.textContent = `Modo experto: ${body.classList.contains('expert') ? 'ON' : 'OFF'}`;
        if(!body.classList.contains('expert')){
          activateTab('inicio');
          localStorage.setItem('dashboard_active_tab','inicio');
        }
      });
    }

    // Drawdown/equity simple chart
    (function(){
      const svg = document.getElementById('equityChart');
      if(!svg) return;
      const data = {{ equity_curve|tojson }};
      if(!Array.isArray(data) || data.length < 2) return;
      const w = 600, h = 180, pad = 20;
      const min = Math.min(...data), max = Math.max(...data);
      const span = (max - min) || 1;
      const x = (i) => pad + (i/(data.length-1))*(w-2*pad);
      const y = (v) => h-pad-((v-min)/span)*(h-2*pad);
      const pts = data.map((v,i)=>`${x(i)},${y(v)}`).join(' ');
      const baseY = y(0);
      svg.innerHTML = `
        <line x1="${pad}" y1="${baseY}" x2="${w-pad}" y2="${baseY}" stroke="#35518a" stroke-dasharray="4 4" />
        <polyline points="${pts}" fill="none" stroke="#8ad4ff" stroke-width="2.5" />
      `;
    })();

    setTimeout(() => location.reload(), 30000);
  </script>
</body>
</html>
